CREATE FUNCTION MEDIAN_ORDER() RETURNS FLOAT
  AS 'WITH ORDERS (ORDER_PRICE) as (
    SELECT SUM(MAIN.TRANSACTION_PRODUCT.QUANTITY*MAIN.PRODUCT.CURRENT_ITEM_PRICE) AS ORDER_PRICE
        FROM MAIN.TRANSACTION
        INNER JOIN MAIN.TRANSACTION_PRODUCT
                ON MAIN.TRANSACTION_PRODUCT.TRANSACTION_ID = MAIN.TRANSACTION.ID 
        INNER JOIN MAIN.PRODUCT 
                ON MAIN.PRODUCT.ID = MAIN.TRANSACTION_PRODUCT.PRODUCT_ID 
    GROUP BY MAIN.TRANSACTION.ID
  )
  SELECT PERCENTILE_CONT(0.5) WITHIN GROUP(ORDER by ORDER_PRICE) FROM ORDERS'
  LANGUAGE SQL
  IMMUTABLE
  RETURNS NULL ON NULL INPUT;

CREATE FUNCTION MEAN_ORDER() RETURNS NUMERIC
  AS 'WITH ORDERS (ORDER_PRICE) as (
    SELECT SUM(MAIN.TRANSACTION_PRODUCT.QUANTITY*MAIN.PRODUCT.CURRENT_ITEM_PRICE) AS ORDER_PRICE
        FROM MAIN.TRANSACTION
        INNER JOIN MAIN.TRANSACTION_PRODUCT
                ON MAIN.TRANSACTION_PRODUCT.TRANSACTION_ID = MAIN.TRANSACTION.ID 
        INNER JOIN MAIN.PRODUCT 
                ON MAIN.PRODUCT.ID = MAIN.TRANSACTION_PRODUCT.PRODUCT_ID 
    GROUP BY MAIN.TRANSACTION.ID
  )
  SELECT AVG(ORDER_PRICE) FROM ORDERS'
  LANGUAGE SQL
  IMMUTABLE
  RETURNS NULL ON NULL INPUT;  
CREATE FUNCTION MODE_ORDER() RETURNS NUMERIC
  AS '
WITH ORDERS (ORDER_PRICE) as (
    SELECT SUM(MAIN.TRANSACTION_PRODUCT.QUANTITY*MAIN.PRODUCT.CURRENT_ITEM_PRICE) AS ORDER_PRICE
        FROM MAIN.TRANSACTION
        INNER JOIN MAIN.TRANSACTION_PRODUCT
                ON MAIN.TRANSACTION_PRODUCT.TRANSACTION_ID = MAIN.TRANSACTION.ID 
        INNER JOIN MAIN.PRODUCT 
                ON MAIN.PRODUCT.ID = MAIN.TRANSACTION_PRODUCT.PRODUCT_ID 
    GROUP BY MAIN.TRANSACTION.ID
)
SELECT mode() WITHIN GROUP (ORDER BY ORDER_PRICE) AS modal_value FROM ORDERS'
LANGUAGE SQL
  IMMUTABLE
  RETURNS NULL ON NULL INPUT;  


CREATE VIEW MAIN.STATS AS SELECT MEDIAN_ORDER(), MEAN_ORDER(), MODE_ORDER();